language: minimal
arch: amd64
dist: focal
branches:
  except:
    - CI-latest
    - CI-refactor-latest

matrix:
  include:
    - name: MacOS native compilation
      os: osx
      osx_image: xcode13.1
      addons:
        homebrew:
          packages:
            - libusb
            - libpng
            - zlib
            - cc65
            - p7zip
      script:
      - make USE_LOCAL_CC65=1 arcmac
      before_deploy:
      - |
        if [[ -z "$TRAVIS_TAG" ]]; then
          if [[ "$TRAVIS_BRANCH" == "refactor_m65" || "$TRAVIS_BRANCH" == "jenkins_test" ]]; then
            export TRAVIS_TAG=CI-refactor-latest
          else
            export TRAVIS_TAG=CI-latest
          fi
        fi
      - echo "Publishing to $TRAVIS_TAG"
      deploy:
      - provider: releases
        api_key: $GITHUB_API_KEY
        file_glob: true
        file:
        - $TRAVIS_BUILD_DIR/m65tools-*.7z
        skip_cleanup: true
        prerelease: true
        draft: false
        overwrite: true
        on:
          tags: false
          all_branches: true
          condition: $TRAVIS_BRANCH =~ ^jenkins_test$
